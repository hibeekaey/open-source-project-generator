# Staging Security Configuration
# Overrides base security.yaml with staging-specific settings
# Balances security with testing requirements

security:
  # Moderate CSP for staging
  content_security_policy:
    enabled: true
    # Allow some flexibility for testing tools
    default_src: "'self'"
    script_src: "'self' 'unsafe-inline'" # Allow inline scripts for testing
    style_src: "'self' 'unsafe-inline'"
    img_src: "'self' data: https:"
    font_src: "'self' https:"
    connect_src: "'self' https:"
    frame_ancestors: "'none'"
    base_uri: "'self'"
    form_action: "'self'"
    upgrade_insecure_requests: true
    # Report violations but don't block in staging
    report_uri: "/api/v1/security/csp-report"
    enforce_mode: false # Report-only for testing

  # Staging session security
  session:
    cookie_secure: true # Require HTTPS in staging
    cookie_same_site: "Strict"
    session_timeout: 1800 # 30 minutes
    absolute_timeout: 21600 # 6 hours
    regenerate_interval: 900 # Every 15 minutes
    
  # Moderate authentication for staging
  authentication:
    password_policy:
      min_length: 10 # Moderate length for staging
      require_uppercase: true
      require_lowercase: true
      require_numbers: true
      require_special_chars: false # Allow simpler passwords for testing
      max_age_days: 180 # 6 months
    
    lockout_policy:
      max_attempts: 5 # Moderate lockout
      lockout_duration: 900 # 15 minutes
      progressive_delay: true
      
    jwt:
      access_token_expiry: 900 # 15 minutes
      refresh_token_expiry: 259200 # 3 days
      refresh_token_rotation: true

  # Moderate rate limiting for staging
  rate_limiting:
    enabled: true
    global:
      requests_per_minute: 100
      burst: 20
    endpoints:
      "/api/v1/auth/login":
        requests_per_minute: 10
        burst: 5
      "/api/v1/auth/register":
        requests_per_minute: 5
        burst: 2
      "/api/v1/auth/password-reset":
        requests_per_minute: 3
        burst: 1
    auto_ban_threshold: 200
    auto_ban_duration: 1800 # 30 minutes

  # Staging input validation
  input_validation:
    max_request_size: "20MB"
    max_json_size: "2MB"
    max_form_size: "10MB"
    max_multipart_size: "50MB"
    
    file_uploads:
      max_file_size: "20MB"
      allowed_extensions:
        - ".jpg"
        - ".jpeg"
        - ".png"
        - ".gif"
        - ".pdf"
        - ".txt"
        - ".csv"
        - ".json"
      scan_for_malware: true # Enable scanning in staging
      quarantine_suspicious: true

  # Staging database security
  database:
    ssl_mode: "require"
    ssl_cert_verification: true
    connection_encryption: true
    query_timeout: 30
    audit_queries: true # Enable auditing in staging
    encrypt_sensitive_fields: true

  # Balanced logging for staging
  logging:
    security_events:
      enabled: true
      log_level: "info"
      
    sanitization:
      enabled: true
      # Moderate redaction for staging
      redacted_fields:
        - "password"
        - "token"
        - "secret"
        - "key"
        - "authorization"
        - "credit_card"
        - "ssn"
      # Allow some fields for testing purposes
      
    retention:
      security_logs_days: 180 # 6 months
      application_logs_days: 90
      debug_logs_days: 14

  # Staging API security
  api:
    swagger_ui_enabled: true # Enable for testing
    api_docs_auth_required: true # Require auth in staging
    remove_server_header: true
    remove_x_powered_by: true
    
  # Staging monitoring
  monitoring:
    security_monitoring:
      enabled: true
      alert_thresholds:
        failed_logins_per_minute: 20
        rate_limit_violations_per_minute: 100
        csp_violations_per_minute: 10
        suspicious_requests_per_minute: 50
      
      # Moderate alerting in staging
      real_time_alerts: true
      alert_severity: "medium"
      
    health_checks:
      include_security_status: true
      check_certificate_expiry: true
      check_dependency_vulnerabilities: true
      vulnerability_scan_interval: 21600 # Every 6 hours

  # Staging compliance
  compliance:
    audit_trail:
      enabled: true
      include_request_body: false # Don't log sensitive data
      include_response_body: false
      include_headers: true
      retention_days: 180
      
    privacy:
      data_minimization: true
      purpose_limitation: true
      consent_tracking: true
      right_to_erasure: true
      anonymization_enabled: false # Allow real data for testing